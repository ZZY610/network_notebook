# 8. 端口映射与内网穿透
## 1. NAT（网络地址转换）
原始的NAT主要通过将**私有内部地址**一对一映射到**公网外部地址**来实现。

这意味着对于每个内部地址，只有一个对应的外部地址，因此在内部网络中**无法同时建立多个连接到相同外部地址**的会话。即，具有n个公网IP地址的路由器只能有n个内网主机能够与外部通信。

这种方式只适用于一对一的连接。

## 2. NAPT（网络地址与端口转换）

NAPT（Network Address and Port Translation）是NAT（Network Address Translation）的扩展。NAPT在NAT的基础上引入了**端口级别**的转换，允许多个内部设备共享同一个公共IP地址，并且还能够同时处理多个连接，通过将源IP地址、源端口和目标端口映射到不同的内部设备。

具体来说，NAPT允许多个内部设备同时使用同一个公共IP地址来访问互联网，通过使用不同的**源端口号**来区分这些连接。当数据包离开内部网络时，NAPT会将源IP地址和源端口号映射到公共IP地址和公共端口号上，这样外部网络就能够识别并正确路由响应数据包。

相比于NAT，NAPT的主要优势是
- 提高了内部网络的安全性
- 进一步减少了公共IP地址的使用

NAPT还是有缺点。它只能为**内部**发起的请求创建映射规则，不能为外部设备向内网发起的请求创建映射。

现在说NAT，其实指的就是NAPT，不做区分。
## 3. 端口映射

由此延伸出了**端口映射**的概念。如果在NAT路由器上配置好端口映射（也即端口转发）的规则，指定外部请求的端口映射到内网的特定设备的端口，就能提供外网访问内网设备的途径。

需要说明的是，端口映射并不是NAT独有的应用。 **端口映射指同一或不同的网络间的设备，通过映射端口号来定位和访问另一台设备上运行的服务。** 实现的方法有很多，包括

- NAT网络地址转换。
- 路由器端口转发。
- 隧道技术（SSH隧道）。
- 反向代理（nginx）。
- P2P穿透。

## 4. 内网穿透
内网穿透（Intranet Penetration），也称为内网映射、内网渗透，允许**外部网络**或用户访问位于**内部网络**中的资源，即使这些资源通常位于由防火墙、路由器或其他网络安全设备保护的私有网络中。

内网穿透实现方法很多，例如使用VPN、隧道等建立连接并穿越网络边界，从而实现内部网络资源的**远程访问**。

内网穿透需要**中间服务器**的转发才能实现。

应用场景：

1. **远程访问**：在公司外的办公人员，可以通过VPN远程访问内部网络中的资源。也可以用于远程支持客户解决问题。

2. **IoT设备管理**：对于分布式的物联网（IoT）设备，内网穿透可以用于对这些设备进行远程管理、维护和监控。

3. **联机游戏**：在本地启用游戏的服务端，在公网服务器上配置内网穿透服务，达到联机的效果。

6. **开发和测试**：开发人员可以使用内网穿透来远程访问位于内部网络中的开发和测试环境，以便在不同地点进行开发和测试。

内网穿透通常需要使用特定的软件工具或服务，这些工具可以帮助建立连接并维护安全性，以确保只有授权的用户能够访问内部资源。常用的内网穿透工具包括SSH隧道、VPN、端口映射工具等。这些工具可以提供加密和身份验证，确保数据的机密性和完整性，并减少潜在的安全风险。

1. **端口映射**：通过将公共网络上的端口映射到内部网络上的特定主机或服务，实现内网穿透。

2. **NAT（网络地址转换）**：NAT通常用于将内部网络的IP地址转换为公共网络上的单一IP地址，以便内部资源可以与外部通信。

3. **VPN（虚拟专用网络）**：VPN是一种通过公共网络建立安全连接的技术，允许用户远程访问内部网络资源。

4. **隧道协议**：隧道协议允许将数据封装在另一个协议中，并在网络上传输。SSH隧道是一个示例，用于安全地传输数据和实现内网穿透。

5. **远程桌面协议**：远程桌面协议允许用户远程控制和操作远程计算机桌面，从而实现内网穿透。

这些技术的共同目标是提供安全、可靠的方式，允许外部网络或用户与内部网络资源进行通信，同时维护网络的安全性和隐私。内网穿透是网络管理和安全领域的重要主题，它使组织能够在不同地理位置之间共享资源，并提供对远程用户的访问。